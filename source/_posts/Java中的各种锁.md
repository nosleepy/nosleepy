---
title: Java中的各种锁
date: 2020-09-10 18:37:03
tags:
- 锁
categories:
- Java并发
---

**synchronized锁升级**

偏向锁 -> 轻量级锁 -> 重量级锁。

**偏向锁**

初次执行到synchronized代码块的时候，锁对象变成**偏向锁**（通过CAS修改对象头里的锁标志位），字面意思是"偏向于第一个获得它的线程"的锁。执行完同步代码块后，线程并不会主动释放偏向锁。当第二次到达同步代码块时，线程会判断此时持有锁的线程是否就是自己（持有锁的线程ID也在对象头里），如果是则正常往下执行。由于之前没有释放锁，这里也就不需要重写加锁。如果自始至终使用锁的线程只有一个，很明显偏向锁几乎没有额外开销，性能极高。

**轻量级锁**

一旦有第二个线程加入锁竞争，**偏向锁**就升级为**轻量级锁**。
锁竞争：如果多个线程轮流获取一个锁，但是每次获取锁的时候都很顺利，没有发生阻塞，那么就不存在锁竞争。只有当某线程尝试获取锁的时候，发现该锁已经被占用，只能等待其释放，这才发生了锁竞争。

**重量级锁**

在**轻量级锁**状态下继续锁竞争，没有抢到锁的线程将自旋，即不停地循环判断锁是否能被成功获取，获取锁的操作，其实就是通过CAS修改对象头里的锁标志位。如果锁竞争情况严重，某个达到最大自旋次数的线程，会将**轻量级锁**升级为**重量级锁**。当后续线程尝试获取锁时，发现被占用的锁是重量级锁，则直接将自己挂起，等待将来被唤醒。

**参考**

+ [通俗易懂 悲观锁、乐观锁、可重入锁、自旋锁、偏向锁、轻量/重量级锁、读写锁、各种锁及其Java实现！](https://zhuanlan.zhihu.com/p/71156910)